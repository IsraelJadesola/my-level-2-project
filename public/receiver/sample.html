<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eazy Food Share | Receiver Dashboard</title>
    <!-- Load Bootstrap CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="sample.css">
</head>

<body>
    <!-- 1. Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container py-2 px-4">
            <a class="navbar-brand fw-bold fs-4 text-dark d-flex align-items-center" href="index.html">
                <i data-lucide="leaf" class="text-primary-custom"
                    style="width: 1.5rem; height: 1.5rem; margin-right: 8px;"></i>
                <span class="text-primary-custom">Eazy Food</span>Share
            </a>

            <!-- Dashboard Action Buttons -->
            <div class="ms-auto d-flex align-items-center gap-2">
                <button class="btn btn-signout-custom px-4" id="signOutBtn">
                    <i data-lucide="log-out" style="width: 1.2rem; height: 1.2rem;"></i>
                    Sign Out
                </button>
            </div>
        </div>
    </nav>

    <!-- 2. Main Dashboard Content -->
    <main class="container py-5">
        <div class="row">
            <div class="col-12">

                <!-- USER INFO CARD -->
                <div class="bg-white info-card p-4 p-md-5 mb-5">

                    <h1 class="fs-2 fw-bold text-primary-custom mb-2">
                        Welcome, Receiver!
                    </h1>

                    <div id="displayName" class="fs-4 fw-semibold text-dark">Loading User...</div>

                    <div class="text-secondary mt-1 small">
                        Email: <span id="displayEmail" class="fw-medium"></span> &bull;
                        Location: <span id="displayLocation" class="fw-medium"></span> &bull;
                        UID: <span id="displayUid" class="fw-medium text-danger"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- LISTINGS SECTION -->
        <div class="row">
            <div class="col-12">
                <h2 class="fs-3 fw-semibold mb-4 text-primary-custom">Available Food Listings Near You</h2>

                <div id="listingsContainer" class="row g-4">
                    <!-- Food listings will be dynamically inserted here -->
                    <div class="col-12 text-center" id="loadingListings">
                        <div class="spinner-border text-primary-custom" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Fetching fresh food listings...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-auto">
        <div class="container text-center">
            <p class="mb-0">EazyFoodShare &copy; 2025 | Built with HTML, CSS, Bootstrap, JavaScript, & Firebase |
                <a href="#" class="text-white text-decoration-none">Privacy Policy</a>
            </p>
        </div>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, update, serverTimestamp, get, query, orderByChild } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- GLOBAL VARIABLES (Mandatory Canvas Variables) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let database, auth, userId;
        let isAuthReady = false;

        // --- UI ELEMENTS AND UTILITIES ---
        const listingsContainer = document.getElementById('listingsContainer');
        const loadingListings = document.getElementById('loadingListings');

        // Custom Modal UI (replacing alert() and confirm())
        function showMessageModal(title, message, isConfirmation = false, onConfirm = () => { }) {
            // Remove any existing modal instance
            const existingModal = document.getElementById('messageModal');
            if (existingModal) existingModal.remove();

            const confirmButton = isConfirmation ?
                `<button type="button" class="btn btn-claim" id="modalConfirmBtn">Yes, Claim Item</button>` : '';

            const modalHtml = `
                <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title" id="messageModalLabel">${title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ${message}
                            </div>
                            <div class="modal-footer">
                                ${confirmButton}
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${isConfirmation ? 'Cancel' : 'Close'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modalElement = document.getElementById('messageModal');
            const modal = new bootstrap.Modal(modalElement);

            if (isConfirmation) {
                document.getElementById('modalConfirmBtn').addEventListener('click', () => {
                    onConfirm();
                    modal.hide();
                });
                // Update header color for confirmation
                modalElement.querySelector('.modal-header').classList.remove('bg-success');
                modalElement.querySelector('.modal-header').classList.add('bg-warning');
                modalElement.querySelector('.modal-header').classList.remove('text-white');
                modalElement.querySelector('.modal-header').classList.add('text-dark');

            }

            modal.show();

            modalElement.addEventListener('hidden.bs.modal', () => {
                modalElement.remove();
            });
        }
        window.showMessageModal = showMessageModal;


        // --- AUTHENTICATION AND INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        database = getDatabase(app);

        // Initial Authentication
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(error => {
                console.error("Error signing in with custom token:", error);
                window.location.replace("receiver-sign-up.html");
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                console.log(`User authenticated: ${userId}`);
                fetchUserProfile(userId);
                setupRealtimeListings(userId);
            } else {
                console.log("No user signed in. Redirecting...");
                window.location.replace("receiver-sign-up.html");
            }
        });

        // --- FIREBASE FUNCTIONS ---

        // 1. Fetch and display user details
        function fetchUserProfile(uid) {
            const profileRef = ref(database, `signedUpUsers/${uid}`);
            get(profileRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('displayName').textContent = data.receiverName || 'N/A';
                    document.getElementById('displayEmail').textContent = data.receiverMail || 'N/A';
                    document.getElementById('displayLocation').textContent = data.receiverAddress || 'N/A';
                    document.getElementById('displayUid').textContent = uid;
                } else {
                    console.error("User profile not found at signedUpUsers/", uid);
                }
            }).catch(error => {
                console.error("Error fetching user profile:", error);
            });
        }

        // 2. Sign Out Function
        document.getElementById('signOutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.replace("receiver-sign-up.html");
            }).catch((error) => {
                console.error("Sign Out Error:", error);
                showMessageModal('Error', 'Failed to sign out. Please try again.');
            });
        });

        // 3. Real-time Listings Listener (Displaying all AVAILABLE donor posts)
        function setupRealtimeListings(uid) {
            // Public path for listings created by donors
            const listingsRef = ref(database, `artifacts/${appId}/public/data/food_listings`);

            // Use onValue to listen for changes to all listings
            onValue(listingsRef, (snapshot) => {
                if (!isAuthReady) return;

                listingsContainer.innerHTML = '';
                let availableListingsFound = false;
                const listingsData = snapshot.val();

                if (listingsData) {
                    const sortedKeys = Object.keys(listingsData).sort((a, b) => {
                        // Sort by timestamp descending (newest first)
                        return listingsData[b].timestamp - listingsData[a].timestamp;
                    });

                    sortedKeys.forEach(key => {
                        const listing = listingsData[key];

                        // Only display listings that are 'Available'
                        if (listing.status === 'Available') {
                            availableListingsFound = true;
                            const itemHtml = createListingCard(key, listing);
                            // Use col-md-6 for two columns on desktop
                            listingsContainer.insertAdjacentHTML('beforeend', `<div class="col-sm-12 col-md-6 col-lg-4">${itemHtml}</div>`);
                        }
                    });
                }

                // --- Empty Listing Message ---
                if (!availableListingsFound) {
                    listingsContainer.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-light text-center py-5 border-dashed" role="alert">
                                <i data-lucide="package-search" class="text-secondary mb-3"
                                    style="width: 2.5rem; height: 2.5rem;"></i>
                                <p class="text-secondary mb-0 fw-medium fs-5">No available food listings right now.</p>
                                <p class="small text-muted mb-0">Check back soon! Donors post items daily.</p>
                            </div>
                        </div>
                    `;
                }

                lucide.createIcons();

            }, (error) => {
                console.error("Error fetching listings:", error);
                listingsContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger" role="alert">Failed to load listings. Please check your connection.</div></div>`;
            });
        }

        // Helper function to create the HTML for an individual listing card
        function createListingCard(listingId, listing) {
            const donorInfo = listing.donorName ? `<p class="mb-2 small text-muted">Donor: ${listing.donorName} from ${listing.donorLocation}</p>` : '';

            return `
                <div class="card p-4 shadow-sm listing-card h-100">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1 fw-semibold">${listing.foodName}</h5>
                            <p class="fs-4 fw-bold mb-3 text-primary-custom">${listing.foodQuantity} ${listing.foodMeasurement}</p>
                            ${donorInfo}
                        </div>
                    </div>
                    
                    <button class="btn btn-claim btn-sm w-100 mt-3" onclick="window.claimFood('${listingId}')">
                        <i data-lucide="hand" style="width: 1rem; height: 1rem;"></i> Claim This Item
                    </button>
                </div>
            `;
        }

        // 4. Claim Food Function (Globally accessible)
        window.claimFood = async function (listingId) {
            if (!isAuthReady || !userId) {
                showMessageModal('Authentication Required', 'You must be signed in to claim food.');
                return;
            }

            const receiverName = document.getElementById('displayName').textContent;

            showMessageModal(
                'Confirm Claim',
                `Do you want to claim **${listingId}**? The donor will be notified of your interest.`,
                true, // isConfirmation = true
                async () => { // onConfirm callback
                    const itemRef = ref(database, `artifacts/${appId}/public/data/food_listings/${listingId}`);

                    try {
                        // Check status again to prevent double-claiming race condition
                        const snapshot = await get(itemRef);
                        if (!snapshot.exists() || snapshot.val().status !== 'Available') {
                            showMessageModal('Already Claimed', 'This item was just claimed by someone else. Please select another listing.');
                            return;
                        }

                        // Update the listing's status and add receiver details
                        await update(itemRef, {
                            status: 'Claimed',
                            claimedByReceiverId: userId,
                            claimedByReceiverName: receiverName,
                            claimedAt: serverTimestamp()
                        });

                        // Success message with next steps (Donor contact info would be revealed here in a full app)
                        showMessageModal('Claim Successful!',
                            '**You have successfully claimed this food item!** The donor has been notified and will contact you shortly to arrange pickup. Check your email for more details.');

                    } catch (error) {
                        console.error("Error claiming listing:", error);
                        showMessageModal('Error', 'Failed to claim listing. Please try again.');
                    }
                }
            );
        }

    </script>

    <!-- Required for Lucide Icons to render -->
    <script>
        lucide.createIcons();
    </script>
    <!-- Include Bootstrap JS for Modal functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>